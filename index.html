<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dispensador de números</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 760px; margin: 32px auto; padding: 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    button { padding: 12px 16px; border-radius: 10px; border: 1px solid #222; background: #222; color: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .muted { color: #666; font-size: 14px; }
    .big { font-size: 28px; font-weight: 700; }
    .err { color: #b00020; }
    ul { padding-left: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  </style>
</head>
<body>
  <h1>Agafar número</h1>

  <div class="card">
    <div class="row">
      <div>
        <div class="muted">Proper número disponible (orientatiu)</div>
        <div id="nextTicket" class="big">—</div>
      </div>
      <div style="flex:1"></div>
      <button id="btnTake">Agafar número</button>
    </div>

    <p id="status" class="muted"></p>
    <p id="error" class="err"></p>

    <hr style="border:none;border-top:1px solid #eee;margin:16px 0">

    <div class="muted">Números que has agafat (aquest dispositiu/navegador)</div>
    <ul id="myTickets"></ul>
    <button id="btnClear" style="background:#fff;color:#222;margin-top:8px">Esborrar llista local</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://vrkbasqaikawkotoorwv.supabase.co";
    const SUPABASE_KEY = "sb_publishable_VZOg0lQDe3snNR0bPgmwxA_NnWoRDvX";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const $next = document.getElementById("nextTicket");
    const $btn = document.getElementById("btnTake");
    const $status = document.getElementById("status");
    const $error = document.getElementById("error");
    const $list = document.getElementById("myTickets");
    const $clear = document.getElementById("btnClear");

    const LS_KEY = "my_taken_tickets_v1";

    function loadLocalTickets() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
      catch { return []; }
    }
    function saveLocalTickets(arr) { localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function renderLocalTickets() {
      const t = loadLocalTickets();
      $list.innerHTML = "";
      for (const n of t) {
        const li = document.createElement("li");
        li.textContent = n;
        $list.appendChild(li);
      }
    }
    function setError(msg) { $error.textContent = msg || ""; }
    function setStatus(msg) { $status.textContent = msg || ""; }

    async function refreshNext() {
      const { data, error } = await sb.rpc("peek_next_ticket");
      if (error) { $next.textContent = "—"; return; }
      $next.textContent = data;
    }

    async function takeTicket() {
      $btn.disabled = true;
      setError("");
      setStatus("Assignant número...");
      const { data, error } = await sb.rpc("take_ticket");
      if (error) {
        setStatus("");
        setError("Error assignant número: " + error.message);
        $btn.disabled = false;
        return;
      }

      const my = loadLocalTickets();
      my.push(data);
      saveLocalTickets(my);
      renderLocalTickets();

      setStatus("Número assignat: " + data);
      await refreshNext();
      $btn.disabled = false;
    }

    setInterval(refreshNext, 3000);
    renderLocalTickets();
    refreshNext();

    $btn.addEventListener("click", takeTicket);
    $clear.addEventListener("click", () => { saveLocalTickets([]); renderLocalTickets(); });
  </script>
</body>
</html>

